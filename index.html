<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Fishly-AI â€” Click Fishing (POV + Cast Bobber)</title>
<style>
  :root{
    --bg:#0a2239; --panel:#0f2d4a; --ink:#e8f1f2; --muted:#9fb3c8;
    --accent:#2bb673; --accent2:#33d68c; --danger:#ff6b6b; --gold:#f5c542;
    --waterTop:#3aaed8; --waterMid:#2b9ec7; --waterDeep:#1f78a1;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:linear-gradient(180deg,#051421 0%,#072535 50%,#0a2239 100%);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:10px 12px;text-align:center;background:#061a2a;position:sticky;top:0;z-index:5;border-bottom:1px solid #0c2c47}
  header h1{margin:0;font-size:20px}
  header small{color:var(--muted)}
  .wrap{max-width:1100px;margin:0 auto;padding:12px}

  .game{display:grid;gap:12px;grid-template-columns:1.4fr 1fr}
  @media (max-width:920px){ .game{grid-template-columns:1fr} }

  /* ===== POV Scene ===== */
  .scene{
    position:relative;min-height:480px;border:1px solid #0f3659;border-radius:12px;overflow:hidden;
    background:
      radial-gradient(ellipse at 50% 16%, #0e3456 0%, transparent 60%),
      linear-gradient(180deg, #0b2a45 0%, #0a2239 100%);
  }
  /* Horizon/sky hint */
  .skyGlow{
    position:absolute;left:0;right:0;top:0;height:110px;
    background:linear-gradient(180deg,#0e3b60 0%,#0b2f4e 70%,transparent 71% 100%);
  }

  /* Dock from POV */
  .dockPOV{
    position:absolute;left:-10px;right:-10px;bottom:0;height:110px;
    background:
      linear-gradient(180deg, rgba(59,38,26,.0) 0%, rgba(59,38,26,.25) 8%, rgba(59,38,26,.55) 100%),
      repeating-linear-gradient(90deg,#6b4a34 0 120px,#5b3f2b 120px 124px);
    border-top:2px solid rgba(0,0,0,.25);
    transform:perspective(800px) rotateX(18deg);
    transform-origin:bottom center;
    box-shadow:0 -20px 60px rgba(0,0,0,.35) inset;
  }

  /* Water band */
  .waterBand{
    position:absolute;left:0;right:0;bottom:110px;top:120px;
    background:
      linear-gradient(180deg,var(--waterTop) 0%, var(--waterMid) 40%, var(--waterDeep) 100%),
      repeating-linear-gradient(0deg,rgba(255,255,255,.06) 0 2px,transparent 2px 6px);
  }

  /* Hand + Rod (POV) */
  .rodLayer{
    position:absolute;right:-40px;bottom:55px;width:420px;height:260px;pointer-events:none;
  }
  .rodLayer svg{filter:drop-shadow(0 3px 8px rgba(0,0,0,.6))}
  .hand{
    position:absolute;right:12px;bottom:42px;width:140px;height:120px;border-radius:16px;
    background:radial-gradient(circle at 30% 35%, #ffe6c9 0%, #f0c9a2 45%, #cf9c6f 100%);
    border:2px solid rgba(80,40,10,.4); transform:rotate(-8deg);
    box-shadow:0 6px 16px rgba(0,0,0,.45);
  }

  /* Bobber */
  .bobber{
    position:absolute; width:14px; height:14px; border-radius:50%;
    background:#ff4757; border:2px solid #fff; pointer-events:none; opacity:0;
  }
  .bob{
    animation: bob 2.2s ease-in-out infinite;
  }
  @keyframes bob{ 0%{transform:translate(-50%,-50%) translateY(-3px)} 50%{transform:translate(-50%,-50%) translateY(3px)} 100%{transform:translate(-50%,-50%) translateY(-3px)} }

  /* Casting trail (faint line) */
  .lineLayer{position:absolute;left:0;right:0;top:0;bottom:0;pointer-events:none}
  .line{position:absolute;height:2px;background:linear-gradient(90deg,rgba(255,255,255,.0),rgba(255,255,255,.8),rgba(255,255,255,.0));transform-origin:0 0;opacity:0}

  /* Sprites layer */
  .sprite-layer{position:absolute; left:0; right:0; top:120px; bottom:110px; pointer-events:none;}
  .popfish{position:absolute; width:120px; height:60px; transform:translate(-50%,-50%) scale(.85); opacity:0; animation: rise 1.1s ease-out forwards;}
  @keyframes rise{
    0%{opacity:0; transform:translate(-50%, -10px) scale(.7) rotate(-6deg)}
    15%{opacity:1; transform:translate(-50%, -6px) scale(1) rotate(0deg)}
    70%{opacity:1; transform:translate(-50%, -46px) scale(1) rotate(0deg)}
    100%{opacity:0; transform:translate(-50%, -70px) scale(.95) rotate(4deg)}
  }
  .splash{position:absolute; width:34px; height:34px; transform:translate(-50%,-50%); opacity:.0; border-radius:50%;
    box-shadow: 0 0 0 0 rgba(255,255,255,.85) inset; animation: splash .6s ease-out forwards;}
  @keyframes splash{
    0%{opacity:0; transform:translate(-50%,-50%) scale(.2)}
    20%{opacity:.9}
    100%{opacity:0; transform:translate(-50%,-50%) scale(1.8)}
  }

  /* UI Panels */
  .panel{background:rgba(9,31,51,.6);border:1px solid #0f3659;border-radius:12px;padding:10px}
  .panel h2{margin:0 0 8px;font-size:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{background:var(--accent);border:none;border-radius:10px;color:#07202e;font-weight:700;padding:9px 12px;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn.alt{background:#1ea0c6;color:#043244}
  .btn.danger{background:var(--danger);color:#330a0a}
  .badge{padding:4px 8px;border-radius:999px;background:#0e3555;border:1px solid #154a73;color:var(--muted);font-size:.85rem}
  .money{color:var(--gold);font-weight:800}

  /* meter */
  .meterWrap{background:#082132;border:1px solid #0e3a5d;border-radius:10px;height:24px;position:relative;overflow:hidden}
  .meterFill{position:absolute;left:0;top:0;bottom:0;width:18%;background:linear-gradient(90deg,#1dd1a1,#10ac84)}
  .meterSweet{position:absolute;top:0;bottom:0;width:20%;left:40%;background:repeating-linear-gradient(90deg,rgba(255,255,255,.25) 0 4px,rgba(255,255,255,.15) 4px 8px)}
  .meterLabel{position:absolute;left:8px;top:2px;font-size:.8rem;color:#d4f3e6}

  .inv{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  .card{background:rgba(13,40,64,.55);border:1px solid #134668;border-radius:10px;padding:8px}
  .card h3{margin:0 0 6px;font-size:14px}
  .list{font-size:.93rem;color:#d7e6f1;max-height:160px;overflow:auto}
  .hint{color:var(--muted);font-size:.9rem}
  .store .row{justify-content:space-between}
  .store .item{display:flex;gap:6px;align-items:center;justify-content:space-between;margin:6px 0}
  .tag{font-size:.75rem;color:#a8d7ff;border:1px solid #2b6fa0;background:#0d3553;padding:2px 6px;border-radius:999px}

  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0f2d4a;border:1px solid #134668;color:#e6f7ff;
    padding:8px 12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.35);z-index:10;opacity:0;pointer-events:none;
    transition:opacity .25s ease, transform .25s ease;}
  .toast.show{opacity:1;transform:translate(-50%, -6px)}
  .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
  .linkish{color:#7fdcff;cursor:pointer;text-decoration:underline}
</style>
</head>
<body>
<header>
  <h1>Fishly-AI â€” Click Fishing</h1>
  <small>POV from the dock â€¢ Cast sends a bobber flying â€¢ Reel to land fish â€¢ Sprites on catch</small>
</header>

<div class="wrap">
  <div class="topbar">
    <div class="row">
      <span class="badge">Coins: <span id="coins">0</span> ðŸ’°</span>
      <span class="badge">Energy: <span id="energy">20</span>/20 âš¡</span>
      <span class="badge">Rod Lv <span id="rodLv">1</span> ðŸŽ£</span>
      <span class="badge">Bucket <span id="bucketUsed">0</span>/<span id="bucketCap">6</span> ðŸª£</span>
      <span class="badge">Bait: <span id="baitTurns">0</span> ðŸŽ¯</span>
    </div>
    <div class="row">
      <button class="btn alt" id="btnMute" aria-label="Toggle sound">ðŸ”Š Sound</button>
      <span class="linkish" id="btnHow">How to play</span>
      <span class="linkish" id="btnReset">Reset</span>
    </div>
  </div>

  <div class="game">
    <!-- LEFT: Scene -->
    <div class="scene" aria-label="Dock POV scene">
      <div class="skyGlow"></div>
      <div class="waterBand"></div>

      <!-- SVG Rod (foreground, right-hand) -->
      <div class="rodLayer" aria-hidden="true">
        <svg viewBox="0 0 420 260" width="100%" height="100%">
          <!-- rod blank -->
          <path d="M400,30 Q280,70 200,140 Q140,180 40,210" stroke="#2a2a2a" stroke-width="10" stroke-linecap="round" fill="none"/>
          <path d="M402,30 Q282,70 202,140 Q142,180 42,210" stroke="#555" stroke-width="4" stroke-linecap="round" fill="none"/>
          <!-- guides -->
          <circle cx="350" cy="46" r="6" fill="#111" stroke="#777"/>
          <circle cx="280" cy="76" r="7" fill="#111" stroke="#777"/>
          <circle cx="210" cy="122" r="8" fill="#111" stroke="#777"/>
          <circle cx="130" cy="168" r="9" fill="#111" stroke="#777"/>
          <!-- reel -->
          <g transform="translate(380,46)">
            <circle cx="0" cy="0" r="18" fill="#2b2f33" stroke="#8aa0b3"/>
            <circle cx="0" cy="0" r="10" fill="#0f1419" stroke="#6f879b"/>
            <rect x="-8" y="18" width="16" height="40" rx="6" fill="#39414a" stroke="#9fb3c8"/>
          </g>
        </svg>
      </div>
      <div class="hand" aria-hidden="true"></div>

      <!-- casting line (faint) -->
      <div class="lineLayer" id="lineLayer"></div>

      <!-- Bobber (created at hand, flies out on cast) -->
      <div class="bobber" id="bobber" title="bobber"></div>

      <!-- SPRITES SHEET -->
      <svg width="0" height="0" style="position:absolute">
        <defs>
          <symbol id="fish-bluegill" viewBox="0 0 120 60">
            <ellipse cx="55" cy="30" rx="32" ry="20" fill="#63a46c" stroke="#2c6b35" stroke-width="2"/>
            <polygon points="20,30 5,22 5,38" fill="#2c6b35"/>
            <circle cx="72" cy="24" r="3" fill="#111"/>
            <path d="M38 18 Q55 10 72 18" fill="none" stroke="#88c886" stroke-width="2"/>
            <path d="M38 42 Q55 50 72 42" fill="none" stroke="#88c886" stroke-width="2"/>
            <circle cx="70" cy="30" r="2" fill="#fff"/>
          </symbol>
          <symbol id="fish-crappie" viewBox="0 0 120 60">
            <ellipse cx="55" cy="30" rx="34" ry="18" fill="#cfd3d6" stroke="#7a8b93" stroke-width="2"/>
            <polygon points="20,30 4,22 4,38" fill="#7a8b93"/>
            <circle cx="72" cy="24" r="3" fill="#111"/>
            <path d="M30 22 l10 4 l-10 4 l10 4 l-10 4" stroke="#8fa2a9" stroke-width="2"/>
          </symbol>
          <symbol id="fish-perch" viewBox="0 0 120 60">
            <ellipse cx="55" cy="30" rx="32" ry="18" fill="#f2c84b" stroke="#b48a1f" stroke-width="2"/>
            <polygon points="20,30 6,22 6,38" fill="#b48a1f"/>
            <rect x="34" y="14" width="6" height="32" fill="#2a4b5f" opacity="0.7"/>
            <rect x="46" y="14" width="6" height="32" fill="#2a4b5f" opacity="0.7"/>
            <rect x="58" y="14" width="6" height="32" fill="#2a4b5f" opacity="0.7"/>
            <circle cx="72" cy="24" r="3" fill="#111"/>
          </symbol>
          <symbol id="fish-largemouth" viewBox="0 0 120 60">
            <ellipse cx="56" cy="30" rx="36" ry="18" fill="#5aa870" stroke="#2d6a43" stroke-width="2"/>
            <polygon points="20,30 4,22 4,38" fill="#2d6a43"/>
            <path d="M78 25 q10 5 10 5 q-10 5 -10 5" fill="#fff" opacity=".8"/>
            <circle cx="75" cy="24" r="3" fill="#111"/>
            <path d="M35 18 Q56 10 77 18" fill="none" stroke="#86c99b" stroke-width="2"/>
            <path d="M35 42 Q56 50 77 42" fill="none" stroke="#86c99b" stroke-width="2"/>
          </symbol>
          <symbol id="fish-smallmouth" viewBox="0 0 120 60">
            <ellipse cx="56" cy="30" rx="34" ry="18" fill="#9a7b50" stroke="#5e4a33" stroke-width="2"/>
            <polygon points="20,30 6,22 6,38" fill="#5e4a33"/>
            <circle cx="74" cy="24" r="3" fill="#111"/>
            <path d="M38 18 Q56 12 74 18" stroke="#b8966a" stroke-width="2" fill="none"/>
            <path d="M38 42 Q56 48 74 42" stroke="#b8966a" stroke-width="2" fill="none"/>
          </symbol>
          <symbol id="fish-walleye" viewBox="0 0 120 60">
            <ellipse cx="60" cy="30" rx="38" ry="16" fill="#9bb17a" stroke="#5b6a47" stroke-width="2"/>
            <polygon points="24,30 6,22 6,38" fill="#5b6a47"/>
            <circle cx="80" cy="24" r="3" fill="#fff"/>
            <circle cx="80" cy="24" r="1.6" fill="#333"/>
            <path d="M40 20 Q60 12 80 20" stroke="#c4d4ad" stroke-width="2" fill="none"/>
          </symbol>
          <symbol id="fish-catfish" viewBox="0 0 120 60">
            <ellipse cx="58" cy="32" rx="36" ry="14" fill="#9aa3ad" stroke="#55616b" stroke-width="2"/>
            <polygon points="26,32 8,26 8,38" fill="#55616b"/>
            <circle cx="78" cy="28" r="3" fill="#212a30"/>
            <path d="M82 30 q10 3 16 0" stroke="#ced7df" stroke-width="2" fill="none"/>
            <path d="M82 32 q10 5 16 6" stroke="#ced7df" stroke-width="2" fill="none"/>
          </symbol>
          <symbol id="fish-pike" viewBox="0 0 140 60">
            <ellipse cx="68" cy="30" rx="48" ry="14" fill="#3d6f4d" stroke="#214531" stroke-width="2"/>
            <polygon points="28,30 6,22 6,38" fill="#214531"/>
            <circle cx="95" cy="24" r="3" fill="#101"/>
            <path d="M40 24 l10 4 l-10 4 l10 4 l-10 4" stroke="#7fb391" stroke-width="2"/>
          </symbol>
          <symbol id="fish-muskie" viewBox="0 0 150 60">
            <ellipse cx="72" cy="30" rx="54" ry="14" fill="#4d7f63" stroke="#294c3a" stroke-width="2"/>
            <polygon points="28,30 6,22 6,38" fill="#294c3a"/>
            <circle cx="104" cy="24" r="3" fill="#101"/>
            <path d="M42 24 l10 4 l-10 4 l10 4 l-10 4" stroke="#97c9a8" stroke-width="2"/>
          </symbol>
          <symbol id="fish-carp" viewBox="0 0 120 60">
            <ellipse cx="58" cy="30" rx="36" ry="18" fill="#caa23a" stroke="#8f7422" stroke-width="2"/>
            <polygon points="22,30 6,22 6,38" fill="#8f7422"/>
            <circle cx="76" cy="24" r="3" fill="#111"/>
            <path d="M40 22 q6 6 12 0 q6 6 12 0" stroke="#edd48a" stroke-width="2" fill="none" opacity=".7"/>
            <path d="M40 36 q6 6 12 0 q6 6 12 0" stroke="#edd48a" stroke-width="2" fill="none" opacity=".7"/>
          </symbol>
        </defs>
      </svg>

      <!-- where catch sprites appear -->
      <div class="sprite-layer" id="spriteLayer" aria-hidden="true"></div>

      <!-- Controls panel sits on dock edge -->
      <div style="position:absolute;left:12px;right:12px;bottom:122px">
        <div class="panel">
          <h2>Cast & Hook</h2>
          <div class="row" style="gap:8px;margin-bottom:8px">
            <button class="btn" id="btnCast">ðŸŽ£ Cast (-1 âš¡)</button>
            <button class="btn" id="btnReel" disabled>ðŸŒ€ Reel</button>
            <button class="btn danger" id="btnSell">ðŸ’µ Sell All</button>
          </div>
          <div class="meterWrap" aria-label="Timing meter">
            <div class="meterSweet" id="sweet"></div>
            <div class="meterFill" id="fill"></div>
            <div class="meterLabel" id="meterLabel">Tap Reel in the sweet zone!</div>
          </div>
          <div class="hint" style="margin-top:6px" id="status">Ready.</div>
        </div>
      </div>

      <div class="dockPOV" aria-hidden="true"></div>
    </div>

    <!-- RIGHT: Inventory & Store -->
    <div class="panel">
      <div class="inv">
        <div class="card">
          <h3>Inventory</h3>
          <div class="list" id="invList"></div>
          <div class="hint">Tip: Better rods widen the sweet zone and increase rare odds.</div>
        </div>
        <div class="card store">
          <h3>Shop</h3>
          <div class="item">
            <div>
              <strong>Rod Upgrade</strong> <span class="tag">+Sweet Zone / +Rare</span><br>
              <small>Current: Lv <span id="rodLv2">1</span></small>
            </div>
            <button class="btn" id="buyRod">Buy (<span class="money" id="rodCost">50</span>)</button>
          </div>
          <div class="item">
            <div>
              <strong>Bucket Upgrade</strong> <span class="tag">+2 slots</span><br>
              <small>Cap: <span id="bucketCap2">6</span></small>
            </div>
            <button class="btn" id="buyBucket">Buy (<span class="money" id="bucketCost">40</span>)</button>
          </div>
          <div class="item">
            <div>
              <strong>Premium Bait</strong> <span class="tag">3 casts: +Rare</span>
            </div>
            <button class="btn" id="buyBait">Buy (<span class="money">20</span>)</button>
          </div>
          <div class="hint">Selling empties your bucket and gives coins. Premium bait stacks in time, not power.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
/* =========================
   DATA & STATE
========================= */
const FISH = [
  {n:"Bluegill", r:"common",  w:[0.2, 1.2], v:4,  sprite:"fish-bluegill"},
  {n:"Crappie",  r:"common",  w:[0.5, 1.8], v:5,  sprite:"fish-crappie"},
  {n:"Perch",    r:"common",  w:[0.3, 1.5], v:5,  sprite:"fish-perch"},
  {n:"Largemouth Bass", r:"uncommon", w:[1.0, 6.0], v:12, sprite:"fish-largemouth"},
  {n:"Smallmouth Bass", r:"uncommon", w:[1.0, 5.0], v:12, sprite:"fish-smallmouth"},
  {n:"Walleye",  r:"uncommon", w:[1.2, 7.0], v:14, sprite:"fish-walleye"},
  {n:"Channel Catfish", r:"uncommon", w:[1.5, 10.0], v:15, sprite:"fish-catfish"},
  {n:"Northern Pike", r:"rare", w:[3.0, 18.0], v:24, sprite:"fish-pike"},
  {n:"Muskellunge", r:"epic", w:[8.0, 35.0], v:60, sprite:"fish-muskie"},
  {n:"Common Carp", r:"uncommon", w:[2.0, 18.0], v:10, sprite:"fish-carp"}
];
const RARITY_WEIGHT = { common:1.0, uncommon:0.45, rare:0.15, epic:0.05 };

const SFX = {
  on:true,
  cast:new Audio('data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA'), // stubs
  reel:new Audio('data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA'),
  sell:new Audio('data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA')
};

const state = {
  coins: 0, energy: 20, energyMax: 20,
  rodLv: 1, bucketCap: 6, inv: [],
  baitTurns: 0,
  casting: false, t: 0, dir: 1,
  sweetStart: 0.4, sweetWidth: 0.20,
  bobberActive: false
};

const UI = {
  coins: $('#coins'), energy: $('#energy'),
  rodLv: $('#rodLv'), rodLv2: $('#rodLv2'),
  bucketUsed: $('#bucketUsed'), bucketCap: $('#bucketCap'), bucketCap2: $('#bucketCap2'),
  baitTurns: $('#baitTurns'),
  btnCast: $('#btnCast'), btnReel: $('#btnReel'), btnSell: $('#btnSell'),
  fill: $('#fill'), sweet: $('#sweet'), label: $('#meterLabel'), status: $('#status'),
  invList: $('#invList'), rodCost: $('#rodCost'), bucketCost: $('#bucketCost'),
  btnRod: $('#buyRod'), btnBucket: $('#buyBucket'), btnBait: $('#buyBait'),
  toast: $('#toast'), btnMute: $('#btnMute'), btnHow: $('#btnHow'), btnReset: $('#btnReset'),
  spriteLayer: $('#spriteLayer'),
  scene: document.querySelector('.scene'),
  waterBand: document.querySelector('.waterBand'),
  dock: document.querySelector('.dockPOV'),
  bobber: document.getElementById('bobber'),
  lineLayer: document.getElementById('lineLayer')
};

/* =========================
   SAVE / LOAD
========================= */
const SAVE_KEY='fishly_click_pov_v1';
function save(){ try{ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }catch{} }
function load(){
  try{
    const raw = localStorage.getItem(SAVE_KEY); if(!raw) return;
    const s = JSON.parse(raw); Object.assign(state, s); state.energyMax=20;
  }catch{}
}
load();

/* =========================
   UTILITIES
========================= */
function $(s){ return document.querySelector(s); }
function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
function rnd(a,b){ return a + Math.random()*(b-a); }
function lerp(a,b,t){ return a + (b-a)*t; }
function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }
function toast(msg){ UI.toast.textContent=msg; UI.toast.classList.add('show'); setTimeout(()=>UI.toast.classList.remove('show'),1600); }
function play(a){ if(SFX.on && a && a.play){ try{ a.currentTime=0; a.play(); }catch{} }}

/* =========================
   SPRITES
========================= */
function showCatchSprite(speciesSprite, x, y){
  const layerRect = UI.spriteLayer.getBoundingClientRect();
  const nx = x ?? (layerRect.width*0.5);
  const ny = y ?? (layerRect.height*0.5);

  // splash
  const splash = document.createElement('div');
  splash.className = 'splash';
  splash.style.left = nx+'px'; splash.style.top = ny+'px';
  UI.spriteLayer.appendChild(splash);
  setTimeout(()=> splash.remove(), 600);

  const holder = document.createElement('div');
  holder.className = 'popfish';
  holder.style.left = nx+'px'; holder.style.top = ny+'px';
  holder.innerHTML = `<svg width="120" height="60" viewBox="0 0 120 60" aria-hidden="true"><use href="#${speciesSprite}"></use></svg>`;
  UI.spriteLayer.appendChild(holder);
  setTimeout(()=> holder.remove(), 1200);
}

/* =========================
   RENDER
========================= */
function recalcSweet(){
  const base = 0.20, per = 0.02;
  state.sweetWidth = base + per*(state.rodLv-1);
  state.sweetStart = 0.5 - state.sweetWidth/2;
  UI.sweet.style.left = (state.sweetStart*100)+'%';
  UI.sweet.style.width = (state.sweetWidth*100)+'%';
}
function render(){
  UI.coins.textContent = state.coins;
  UI.energy.textContent = state.energy;
  UI.rodLv.textContent = state.rodLv; UI.rodLv2.textContent = state.rodLv;
  UI.bucketCap.textContent = state.bucketCap; UI.bucketCap2.textContent = state.bucketCap;
  UI.bucketUsed.textContent = state.inv.length;
  UI.baitTurns.textContent = state.baitTurns;
  UI.btnCast.disabled = state.casting || state.energy<=0 || state.inv.length>=state.bucketCap;
  UI.btnReel.disabled = !state.casting;
  UI.btnSell.disabled = state.inv.length===0;

  const rodC = 50 + (state.rodLv-1)*30;
  const bucketC = 40 + Math.floor((state.bucketCap-6)/2)*25;
  UI.rodCost.textContent = rodC;
  UI.bucketCost.textContent = bucketC;
  UI.btnRod.disabled = state.coins < rodC || state.rodLv>=10;
  UI.btnBucket.disabled = state.coins < bucketC || state.bucketCap>=20;
  UI.btnBait.disabled = state.coins < 20;

  recalcSweet();
  renderInv();
}
function renderInv(){
  if(!state.inv.length){ UI.invList.innerHTML='<em>Empty bucket.</em>'; return; }
  UI.invList.innerHTML = state.inv.map(f=>`<div>â€¢ ${f.n} â€” ${f.w.toFixed(2)} lb <span class="tag ${f.r}">${f.r}</span> <span class="money">+$${f.v}</span></div>`).join('');
}

/* =========================
   CAST ARC + LINE
========================= */
let raf=null, castAnimRaf=null;
function getHandOrigin(){
  // approximate tip of rod/reel area for start of cast (right-lower area)
  const sceneRect = UI.scene.getBoundingClientRect();
  const startX = sceneRect.width - 70;
  const startY = sceneRect.height - 160; // above dock
  return {startX, startY, sceneRect};
}
function getRandomTarget(){
  // target on water band (avoid edges)
  const bandRect = UI.waterBand.getBoundingClientRect();
  const sceneRect = UI.scene.getBoundingClientRect();
  const x = rnd(sceneRect.width*0.20, sceneRect.width*0.80);
  const y = (bandRect.top - sceneRect.top) + rnd(20, bandRect.height-20);
  return {x, y};
}
function drawLine(x0,y0,x1,y1,opacity=1){
  const el = document.createElement('div');
  el.className='line';
  const dx=x1-x0, dy=y1-y0, len=Math.hypot(dx,dy), ang=Math.atan2(dy,dx)*180/Math.PI;
  el.style.left = x0+'px'; el.style.top = y0+'px';
  el.style.width = len+'px'; el.style.transform = `rotate(${ang}deg)`;
  el.style.opacity = opacity;
  UI.lineLayer.appendChild(el);
  setTimeout(()=> el.remove(), 180); // brief trail
}
function animateCastBobber(toX, toY, cb){
  const {startX, startY} = getHandOrigin();
  const bob = UI.bobber;
  bob.style.opacity = 1;
  bob.classList.remove('bob'); // no bob while flying
  // arc path via quadratic bezier with control point above mid
  const cx = (startX + toX)/2 + rnd(-40,40);
  const cy = Math.min(startY, toY) - rnd(80,120); // arch above

  const T = 900; // ms
  const t0 = performance.now();
  (function step(now){
    const t = clamp((now - t0)/T, 0, 1);
    const e = easeOutCubic(t);
    const x = (1-e)*(1-e)*startX + 2*(1-e)*e*cx + e*e*toX;
    const y = (1-e)*(1-e)*startY + 2*(1-e)*e*cy + e*e*toY;
    bob.style.left = x+'px'; bob.style.top = y+'px'; bob.style.transform='translate(-50%,-50%)';
    drawLine(startX, startY, x, y, 0.65*(1-t)+0.15);
    if(t<1){ castAnimRaf = requestAnimationFrame(step); }
    else { bob.classList.add('bob'); cb && cb(x,y); }
  })(performance.now());
}

/* =========================
   GAME LOOP: CAST / METER
========================= */
function choiceWeighted(){
  const bonusRare = 0.02*(state.rodLv-1) + (state.baitTurns>0 ? 0.08 : 0);
  const weights = FISH.map(f=>{
    let w = RARITY_WEIGHT[f.r];
    if(f.r==='uncommon') w += bonusRare*0.6;
    if(f.r==='rare')     w += bonusRare*0.35;
    if(f.r==='epic')     w += bonusRare*0.20;
    return Math.max(0.01, w);
  });
  const sum = weights.reduce((a,b)=>a+b,0);
  let pick = Math.random()*sum;
  for(let i=0;i<FISH.length;i++){
    if(pick<weights[i]) return FISH[i];
    pick -= weights[i];
  }
  return FISH[FISH.length-1];
}

function startCast(){
  state.casting = true; state.bobberActive = true;
  state.energy = Math.max(0, state.energy-1);
  UI.status.textContent = 'Castingâ€¦ time your Reel in the sweet zone!';
  play(SFX.cast);

  // randomize meter sweet spot
  const jitter = rnd(-0.08, 0.08);
  state.sweetStart = clamp(0.5 - state.sweetWidth/2 + jitter, 0.05, 0.95-state.sweetWidth);
  UI.sweet.style.left = (state.sweetStart*100)+'%';

  // bobber: start at hand, fly out
  const {startX, startY} = getHandOrigin();
  UI.bobber.style.left = startX+'px'; UI.bobber.style.top = startY+'px'; UI.bobber.style.transform='translate(-50%,-50%)';
  const tgt = getRandomTarget();
  animateCastBobber(tgt.x, tgt.y, (bx,by)=> {
    // landed â†’ keep bobbing
  });

  // Meter anim
  state.t = Math.random();
  state.dir = Math.random()<0.5 ? -1 : 1;
  function tick(){
    state.t += state.dir * 0.018 * (1 + (state.rodLv-1)*0.03);
    if(state.t<=0){ state.t=0; state.dir=1; }
    if(state.t>=1){ state.t=1; state.dir=-1; }
    UI.fill.style.width = (state.t*100)+'%';
    raf = requestAnimationFrame(tick);
  }
  cancelAnimationFrame(raf);
  raf = requestAnimationFrame(tick);
  render();
}

function stopCast(success){
  state.casting = false;
  cancelAnimationFrame(raf);
  cancelAnimationFrame(castAnimRaf);

  // hide/remove bobber immediately on reel
  UI.bobber.classList.remove('bob');
  UI.bobber.style.opacity = 0;
  state.bobberActive = false;

  if(success){
    if(state.inv.length>=state.bucketCap){
      UI.status.textContent = 'Bucket full! Sell to free space.'; return;
    }
    const f = choiceWeighted();
    const weight = rnd(f.w[0], f.w[1]);
    const variance = rnd(0.9,1.15);
    const value = Math.round(f.v * variance + weight*2);

    // add to inv
    state.inv.push({n:f.n, r:f.r, w:weight, v:value});

    // pop sprite roughly where bobber landed last
    const layerRect = UI.spriteLayer.getBoundingClientRect();
    // find last known bobber position relative to sprite layer
    const bobRect = UI.bobber.getBoundingClientRect();
    const sceneRect = UI.scene.getBoundingClientRect();
    const sx = bobRect.left - sceneRect.left;
    const sy = bobRect.top - sceneRect.top - 120; // spriteLayer starts at top:120
    const x = clamp(sx, 0, layerRect.width);
    const y = clamp(sy, 0, layerRect.height);
    showCatchSprite(f.sprite || 'fish-bluegill', x, y);

    if(state.baitTurns>0) state.baitTurns--;
    UI.status.textContent = `Hooked a ${f.n}! ${weight.toFixed(2)} lb (+$${value}).`;
    play(SFX.reel);
    toast(`+ ${f.n} â€¢ ${weight.toFixed(2)} lb â€¢ $${value}`);
  } else {
    UI.status.textContent = 'Missed it! Try again.';
  }
  render();
}

/* =========================
   ACTIONS & UI
========================= */
UI.btnCast.addEventListener('click', ()=>{
  if(state.energy<=0){ toast("Out of energy! Sell fish for a breather."); return; }
  if(state.inv.length>=state.bucketCap){ toast("Bucket full â€” sell your catch."); return; }
  startCast();
});
UI.btnReel.addEventListener('click', ()=>{
  if(!state.casting) return;
  const x = state.t, s0 = state.sweetStart, s1 = state.sweetStart + state.sweetWidth;
  stopCast(x>=s0 && x<=s1);
});
UI.btnSell.addEventListener('click', ()=>{
  if(!state.inv.length){ toast("Nothing to sell!"); return; }
  const total = state.inv.reduce((a,b)=>a+b.v,0);
  state.coins += total; state.inv = [];
  state.energy = clamp(state.energy+4, 0, state.energyMax);
  play(SFX.sell);
  UI.status.textContent = `Sold catch for $${total}. Energy +4.`;
  render(); save();
});

UI.btnRod.addEventListener('click', ()=>{
  const cost = 50 + (state.rodLv-1)*30;
  if(state.coins<cost) return toast("Not enough coins.");
  if(state.rodLv>=10) return toast("Rod is maxed!");
  state.coins -= cost; state.rodLv++;
  UI.status.textContent = `Upgraded rod to Lv ${state.rodLv}! Wider sweet zone + rarer fish odds.`;
  render(); save();
});
UI.btnBucket.addEventListener('click', ()=>{
  const cost = 40 + Math.floor((state.bucketCap-6)/2)*25;
  if(state.coins<cost) return toast("Not enough coins.");
  if(state.bucketCap>=20) return toast("Bucket at max capacity!");
  state.coins -= cost; state.bucketCap += 2;
  UI.status.textContent = `Bucket upgraded to ${state.bucketCap} slots.`;
  render(); save();
});
UI.btnBait.addEventListener('click', ()=>{
  if(state.coins<20) return toast("Not enough coins.");
  state.coins -= 20; state.baitTurns += 3;
  UI.status.textContent = `Premium bait active for ${state.baitTurns} cast(s).`;
  render(); save();
});

UI.btnMute.addEventListener('click', ()=>{
  SFX.on = !SFX.on;
  UI.btnMute.textContent = SFX.on ? 'ðŸ”Š Sound' : 'ðŸ”ˆ Muted';
});
UI.btnHow.addEventListener('click', ()=>{
  alert(`How to play:
â€¢ You're on a dock holding a rod (POV).
â€¢ Click CAST (uses 1 energy): the bobber flies out and bobs.
â€¢ Click REEL in the green zone to hook a fish. The bobber disappears when reeling.
â€¢ Fish pop up where the bobber was.
â€¢ SELL to earn coins and restore energy.
â€¢ Upgrades: Rod (wider zone + rarer fish), Bucket (+slots), Bait (3 casts with higher rare odds).
â€¢ Autosaves progress. Tight lines!`);
});
UI.btnReset.addEventListener('click', ()=>{
  if(!confirm("Reset progress?")) return;
  localStorage.removeItem(SAVE_KEY);
  Object.assign(state, {coins:0, energy:20, energyMax:20, rodLv:1, bucketCap:6, inv:[], baitTurns:0, casting:false,t:0,dir:1, sweetStart:0.4, sweetWidth:0.20, bobberActive:false});
  UI.bobber.style.opacity=0; UI.bobber.classList.remove('bob');
  UI.status.textContent = "Progress reset.";
  render();
});

/* =========================
   INIT
========================= */
function recalcSweet(){ // redefined above but keep for init scope
  const base = 0.20, per = 0.02;
  state.sweetWidth = base + per*(state.rodLv-1);
  state.sweetStart = 0.5 - state.sweetWidth/2;
  UI.sweet.style.left = (state.sweetStart*100)+'%';
  UI.sweet.style.width = (state.sweetWidth*100)+'%';
}
function renderInv(){ // ensure latest definition used
  if(!state.inv.length){ UI.invList.innerHTML='<em>Empty bucket.</em>'; return; }
  UI.invList.innerHTML = state.inv.map(f=>`<div>â€¢ ${f.n} â€” ${f.w.toFixed(2)} lb <span class="tag ${f.r}">${f.r}</span> <span class="money">+$${f.v}</span></div>`).join('');
}
function renderTop(){ render(); }
function gameInit(){
  recalcSweet(); renderTop();
  setInterval(save, 3000);
}
gameInit();
</script>
</body>
</html>
